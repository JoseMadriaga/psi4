#! MBIS calculation on H2O

charges_ref = psi4.Matrix.from_list([
[-0.61769703312478264],
[0.45335693563341328],
[0.45992179263832167],
[-0.38282429246647176],
[-0.021262962654431838],
[-0.22448675694656561],
[-0.041496556635303605],
[-0.31486075343138165],
[0.14562553525615618],
[0.12096014292334101],
[0.1371368783859015],
[0.12390324007175313],
[0.16151968273139183]   
])

dipoles_ref = psi4.Matrix.from_list([
[-0.096515296980794654, -0.033507553502514005, -0.030643177595638768],
[0.025489073150666869, 0.0014403005510479187, 0.012411709170907888],
[0.052684402147705651, 0.13165431616020321, -0.04425898288709635],
[0.016089618893788103, -0.044389687484479842, 0.040103848779636624],
[0.010715806265527405, 0.018223964573838423, -0.0039392986181938493],
[-0.0047518319862506295, 0.00033405101109967178, -0.0032310094076410038],
[0.0058422826833499633, 0.0052215350323764455, 0.0006843304116663742],
[-0.026747144061487597, 0.0075856371536904294, -0.019826232145515581],
[0.044185990571563034, 0.0015926164271204231, 0.027430384592652953],
[0.025526474007294672, -0.03988192999966321, 0.040303437342178242],
[-0.028047112284551812, -0.047946899642906354, 0.011888368960644958],
[-0.05428238420243249, -0.010748259084085256, -0.02718866065722278],
[-0.018159621468971369, 0.037539370517337252, -0.034397184346686774]
])

quadrupoles_ref = psi4.Matrix.from_list([
[-4.2509465042746104, 0.035693667315733743, 0.022080861665087201, -4.2834588402786871, -0.0085556824723348798, -4.3141344704537898],
[-0.24677558831999236, 0.0015992112471228553, 0.0031478407225056333, -0.2456572238049255, -0.0043966786674526559, -0.25088205009792636],
[-3.7196284096420151, 0.015283495086290495, -0.10134674434996609, -3.5867737369105281, 0.024723339306947364, -3.6478358232764077],
[-5.0523820168200402, -0.037355560803561005, -0.012699826023928752, -5.1624080009491458, 0.083881223086120421, -5.0512176423723334],
[-4.4725219982621569, -0.080962746641620356, -0.045386838352009996, -4.4474348854174099, 0.02812651903394716, -4.3650969925735366],
[-4.8329270879629433, 0.01493240983456191, -0.088437368141794537, -4.7693332842315286, 0.04816832275201563, -4.7906185279870472],
[-4.4381584319083931, -0.031554475377265384, -0.033568496058127742, -4.5332365579328391, 0.090947521220835381, -4.4292680304671341],
[-4.9590638077275182, -0.056329914340706534, -0.050855363836130027, -4.8897079992850889, 0.0089608695587770435, -4.8566054550203912],
[-0.48130544924922797, 0.00057144645774613557, 0.0030408172878285539, -0.46897318043696057, -0.010151859763102095, -0.47838028269514943],
[-0.48260835052689433, 0.010917084731437406, 0.0044251759888602757, -0.4872013077438147, -0.0012160843215467086, -0.49688026951158409],
[-0.47357488802178599, -0.001991945163110308, 0.012065614598454483, -0.48251968731796985, -0.0063889306053157924, -0.4795234868108082],
[-0.49128935225776271, 0.0024667486813550643, 0.0018836456528101525, -0.47708937661255363, -0.010514927928548931, -0.48916013934351715],
[-0.4492939269606927, 0.011416991528711395, 0.0045550112959722999, -0.45342762143273507, -0.0016541585814467488, -0.46382677161276825]
])                                       

octupoles_ref = psi4.Matrix.from_list([
[-0.32048921729120616, 0.04857410845654684, -0.12735912850384395, 0.092322368271778255, -0.043050055506561401, -0.10160187722436814, 0.17584245678876473, -0.092581046108613466, -0.016033110081755408, -0.062596928847073782],
[0.019221384344647097, -0.00074723401755705308, 0.0035173323471614673, 0.0061145416126130907, 0.0011216007890077092, 0.0050965889478059223, 0.00062620274283473748, 0.00032126408310731371, 0.00095819602595121451, 0.011018136165094818],
[0.23453384555159471, 0.059716211392311737, 0.01227567287317698, -0.21145704042365626, 0.10357159835762969, 0.065367514628868029, 0.16140538462694121, 0.0058074391296989367, 0.20923751875122068, -0.20004173562973893],
[-0.081705254379338885, -0.12090206381999612, -0.071901757431731009, 0.26238120826402439, -0.16908178961140499, 0.096522418985676026, 0.10888464024889685, 0.07880897736750038, -0.13465505511877696, 0.28745153489244679],
[0.31601105496046894, 0.00046226704565236181, 0.14474565539978429, -0.17065333597648394, 0.14440496374323961, 0.019882384938982273, -0.21309256578883876, -0.00015758277137256087, 0.094219244770124652, 0.035894025282650226],
[-0.32947092715545978, -0.065805549769464525, -0.12044201174579545, 0.18077578419670484, -0.1507855348372665, -0.01865935777960891, 0.00067347426678596612, 0.068072724346393512, -0.17235640678178579, 0.093392638942566206],
[0.06526808922195293, 0.006729756666855, 0.11034993328927556, -0.25029883655225893, 0.133982282437835, -0.056890084346400242, -0.15654850515891416, -0.083267935928206638, 0.10081650600358348, -0.14498205434265213],
[-0.33127770522731059, 0.071228237741841727, -0.21001922464969569, 0.22387774406638256, -0.15818609248152535, -0.023821040929173056, 0.34124739630166856, 0.029268592269771517, -0.078919817805746223, -0.094983014718558259],
[0.026552169170689435, -0.0053583752569230847, 0.0073412333284420157, 0.011375937864952588, -0.0016275085467026917, 0.010188927627567325, -0.013160443155047235, 0.011656875109142702, -0.0061309388059080762, 0.029316618183019991],
[0.027258924150576725, -0.0089681189627086877, 0.013176608168215271, 0.0022932139854668098, 0.0031859946570779252, 0.0074259129363231525, -0.031393241592276563, 0.0097040802409234152, -0.0067028856648615256, 0.029066276990743774],
[-0.026920950901505567, -0.012299933439366331, 0.00061730840226233619, -0.0026513088625413814, -0.0030543370444441162, -0.0073786926403901368, -0.033358975732263638, 0.0034303083196065231, -0.01487382551975429, 0.01003307466032053],
[-0.0359115005957737, -0.0022175447801982624, -0.0045120486020962334, -0.018603449924894804, 0.0034507555915836343, -0.013991385851153712, -0.010566317030307406, -0.0081610894413234741, 0.00059533645514082598, -0.022431266392374204],
[-0.013297138223180606, 0.0098448966557210405, -0.010974808814148326, -0.00024309183499349014, -0.0020628682761438147, -0.0029252261483450259, 0.031571155792502525, -0.0060142489264465296, 0.0082324293855931419, -0.023586037238820877]
])
                                                              

molecule mol {
  0 1
  O    -1.3885044    1.9298523   -0.4431206
  H    -0.5238121    1.9646519   -0.0064609
  C    -2.0071056    0.7638459   -0.1083509
  C    -1.4630807   -0.1519120    0.7949930
  C    -2.1475789   -1.3295094    1.0883677
  C    -3.3743208   -1.6031427    0.4895864
  C    -3.9143727   -0.6838545   -0.4091028
  C    -3.2370496    0.4929609   -0.7096126
  H    -0.5106510    0.0566569    1.2642563
  H    -1.7151135   -2.0321452    1.7878417
  H    -3.9024664   -2.5173865    0.7197947
  H    -4.8670730   -0.8822939   -0.8811319
  H    -3.6431662    1.2134345   -1.4057590
  symmetry c1
  no_reorient
  no_com
}

set {
  scf_type df
  d_convergence 8
  e_convergence 10
  mbis_maxiter 200
  mbis_d_convergence 1e-8
  dft_pruning_scheme none
  dft_radial_points 99
  dft_spherical_points 590
  debug 1
}

e, wfn = energy('hf/cc-pvdz', return_wfn=True)
oeprop(wfn, 'MBIS_CHARGES', title='PhOH SCF')

charges = wfn.variable('MBIS_CHARGES')
dipoles = wfn.variable('MBIS_DIPOLES')
quadrupoles = wfn.variable('MBIS_QUADRUPOLES')
octupoles = wfn.variable('MBIS_OCTUPOLES')

compare_matrices(charges_ref, charges, 3, "MBIS Charges")             #TEST
compare_matrices(dipoles_ref, dipoles, 3, "MBIS Dipoles")             #TEST
compare_matrices(quadrupoles_ref, quadrupoles, 3, "MBIS Quadrupoles") #TEST
compare_matrices(octupoles_ref, octupoles, 3, "MBIS Octupoles")       #TEST
