#! MBIS calculation on H2S

charges_ref = psi4.Matrix.from_list([   #TEST
[-0.3265952921558295],
[0.16328062921766406],
[0.16327689642890164]
])

dipoles_ref = psi4.Matrix.from_list([   #TEST
[-0.12988517021041662, -0.12988456736363302, 7.285272466748028e-08],
[0.07989848233171429, -0.002249410565628238, 3.4592084397339444e-07],
[-0.0022495874920683574, 0.07990285855919688, -4.1038660645678124e-07]
])

quadrupoles_ref = psi4.Matrix.from_list([                                             #TEST
[-9.91040207752907, -0.3009873787133395, 3.118738515265896e-07, -9.910401860351167, -2.732161310177296e-07, -11.166667143642053],
[-0.491011271109291, 0.0031664712621888203, -9.454268994517547e-07, -0.4821709445144156, 1.750556568632911e-07, -0.5159578805925096],
[-0.4821750553997042, 0.003166866959600787, 2.401170201106512e-08, -0.4910228433382938, 8.386633666268609e-07, -0.5159624115993418]
])

octupoles_ref = psi4.Matrix.from_list([                                              #TEST
[-1.9483578945013846, 0.08089265912457849, 4.2911138469770845e-07, 0.08088944138247553, 6.045401328299621e-08, 0.015857895316548503, -1.9483414964872527, -5.231680014192188e-07, 0.01586723785924129, -2.282994322188538e-08],
[0.09453849664308582, -0.005962973654128983, 2.4926746636015945e-06, 0.0413236161544674, -5.135768407973942e-07, 0.055724832365823075, -0.028611860650398502, -3.451720298953762e-08, -0.0014374825987704442, 1.968481576550657e-07],
[-0.028612613526178256, 0.04132578451088965, -3.1800589812945736e-07, -0.0059648270898946445, -3.1163903220158753e-07, -0.001437703134337015, 0.09456334414729854, -1.8124799939527937e-06, 0.05572694181532008, -1.446090020389638e-07]
])

molecule mol {
0 1
S  0.000 0.000 0.000
H  1.336 0.000 0.000
H  0.000 1.336 0.000
  symmetry c1
  no_reorient
  no_com
}

set {
  scf_type df
  d_convergence 8
  e_convergence 10
  mbis_maxiter 500
  mbis_d_convergence 1e-8
  dft_pruning_scheme none
  dft_radial_points 99
  dft_spherical_points 590
}

e, wfn = energy('hf/cc-pvdz', return_wfn=True)
oeprop(wfn, 'MBIS_CHARGES', title='H2S SCF')

charges = wfn.variable('MBIS_CHARGES')
dipoles = wfn.variable('MBIS_DIPOLES')
quadrupoles = wfn.variable('MBIS_QUADRUPOLES')
octupoles = wfn.variable('MBIS_OCTUPOLES')

compare_matrices(charges_ref, charges, 3, "MBIS Charges")             #TEST
compare_matrices(dipoles_ref, dipoles, 3, "MBIS Dipoles")             #TEST
compare_matrices(quadrupoles_ref, quadrupoles, 3, "MBIS Quadrupoles") #TEST
compare_matrices(octupoles_ref, octupoles, 3, "MBIS Octupoles")       #TEST
